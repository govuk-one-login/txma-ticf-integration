AWSTemplateFormatVersion: '2010-09-09'
Description: Integrate TxMA service with Zendesk in order to automate Athena queries
Transform: AWS::Serverless-2016-10-31

Parameters:
  CodeSigningConfigArn:
    Description: The ARN of the Code Signing Config to use, provided by the deployment pipeline
    Type: String
    Default: none
  Environment:
    Description: The environment type
    Type: String
    AllowedValues:
      - dev
      - build
      - staging
      - integration
      - production
  PermissionsBoundary:
    Description: The ARN of the permissions boundary to apply to any role created by the template
    Type: String
    Default: none
  TestRoleArn:
    Type: String
    Description: The ARN of the role that will used for integration tests
    Default: none
  VpcStackName:
    Type: String
    Description: The name of the stack containing the VPC
    Default: none
  LogSubscriptionFilterPattern:
    Type: String
    Description: The default filter used when forwarding CloudWatch logs to external logging apps such as CSLS and Splunk
    Default: '{ $.errorMessage = * || ($.level = * && $.level != %TRACE|DEBUG%) }'

Conditions:
  ApiCustomDomain: !Not [!Equals [!Ref Environment, dev]]
  CslsEgress:
    !Or [
      !Equals [!Ref Environment, production],
      !Equals [!Ref Environment, integration],
      !Equals [!Ref Environment, staging]
    ]
  DevEnvironment: !Equals [!Ref Environment, dev]
  BuildEnvironment: !Equals [!Ref Environment, build]
  TestEnvironment:
    !Not [
      !Or [
        !Equals [!Ref Environment, production],
        !Equals [!Ref Environment, integration]
      ]
    ]
  TestRoleResources:
    !And [Condition: TestEnvironment, !Not [!Equals [!Ref TestRoleArn, none]]]
  UseCodeSigning: !Not [!Equals [!Ref CodeSigningConfigArn, none]]
  UsePermissionsBoundary: !Not [!Equals [!Ref PermissionsBoundary, none]]
  UseCanaryDeploy: !Or
    - !Equals [!Ref Environment, production]
    - !Equals [!Ref Environment, integration]

Mappings:
  EnvironmentConfiguration:
    dev:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
    build:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
    staging:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
    integration:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
    production:
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceProductionVariables

Globals:
  Function:
    Architectures:
      - 'arm64'
    CodeSigningConfigArn:
      !If [UseCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue]
    Environment:
      Variables:
        NODE_OPTIONS: --enable-source-maps
        AWS_LAMBDA_EXEC_WRAPPER: /opt/dynatrace
        DT_CONNECTION_AUTH_TOKEN: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_AUTH_TOKEN}}'
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn
              ]
        DT_CONNECTION_BASE_URL: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_BASE_URL}}'
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn
              ]
        DT_CLUSTER_ID: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CLUSTER_ID}}'
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn
              ]
        DT_LOG_COLLECTION_AUTH_TOKEN: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_LOG_COLLECTION_AUTH_TOKEN}}'
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn
              ]
        DT_TENANT: !Sub
          - '{{resolve:secretsmanager:${SecretArn}:SecretString:DT_TENANT}}'
          - SecretArn:
              !FindInMap [
                EnvironmentConfiguration,
                !Ref Environment,
                dynatraceSecretArn
              ]
        DT_OPEN_TELEMETRY_ENABLE_INTEGRATION: 'true'
    PermissionsBoundary:
      !If [UsePermissionsBoundary, !Ref PermissionsBoundary, !Ref AWS::NoValue]
    # concurrency is set low so that audit firehose has enough concurrency to run during peak loads and write the audit data to s3. we are happy to slow down ticf integration
    ReservedConcurrentExecutions: 10
    Runtime: nodejs22.x
    Timeout: 30
    VpcConfig:
      SecurityGroupIds:
        - Fn::ImportValue: !Sub ${VpcStackName}-AWSServicesEndpointSecurityGroupId
    Layers:
      - arn:aws:lambda:eu-west-2:216552277552:layer:Dynatrace_OneAgent_1_313_2_20250404-043044_with_collector_nodejs:1
    AutoPublishAlias: live
  Api:
    OpenApiVersion: 3.0.1

Resources:
  ###############
  # API Resources
  ###############

  ZendeskWebhookApi:
    #checkov:skip=CKV_AWS_120:We explicitly don't want caching because we want the lambda to fire off every time a Zendesk ticket is approved
    Type: AWS::Serverless::Api
    Properties:
      AccessLogSetting:
        DestinationArn: !GetAtt ZendeskWebhookAccessLogGroup.Arn
        Format: >-
          {
          "requestId": "$context.requestId",
          "ip": "$context.identity.sourceIp",
          "requestTime": "$context.requestTime",
          "httpMethod": "$context.httpMethod",
          "path": "$context.path",
          "routeKey": "$context.routeKey",
          "status": "$context.status",
          "protocol": "$context.protocol",
          "responseLatency": "$context.responseLatency",
          "responseLength": "$context.responseLength"
          }
      Description: API called by Zendesk webhooks to begin automated Athena queries
      DisableExecuteApiEndpoint: !If [ApiCustomDomain, true, false]
      EndpointConfiguration:
        Type: REGIONAL
      Name: !Sub ${AWS::StackName}-zendesk-webhook-api
      TracingEnabled: true
      StageName: !Ref Environment
      DefinitionBody:
        'Fn::Transform':
          Name: 'AWS::Include'
          Parameters:
            Location: dist/open-api-specification.yaml

  ZendeskWebhookApiBasePathMapping:
    Condition: ApiCustomDomain
    Type: AWS::ApiGateway::BasePathMapping
    Properties:
      DomainName: '{{resolve:ssm:ZendeskWebhookApiDomainName}}'
      RestApiId: !Ref ZendeskWebhookApi
      Stage: !Ref ZendeskWebhookApi.Stage

  ZendeskWebhookAccessLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: '{{resolve:ssm:LogsKmsKeyArn}}'
      LogGroupName: !Sub /aws/apigateway/${AWS::StackName}-zendesk-webhook-api-access-logs
      RetentionInDays: 30

  ZendeskWebhookAccessCslsSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Condition: CslsEgress
    Properties:
      LogGroupName: !Ref ZendeskWebhookAccessLogGroup
      FilterPattern: ''
      DestinationArn: '{{resolve:ssm:CSLSLogsDestination}}'

  ##################
  # Lambda Resources
  ##################

  LambdaDeployRole:
    Type: AWS::IAM::Role
    # checkov:skip=CKV_AWS_111: "Ensure IAM policies does not allow write access without constraints
    # The network interface permissions can only be applied at the '*' resource level
    Properties:
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codedeploy.eu-west-2.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSCodeDeployRoleForLambda'

  TICFIntegrationDeploymentStrategy:
    Condition: UseCanaryDeploy
    Type: AWS::CodeDeploy::DeploymentConfig
    Properties:
      ComputePlatform: Lambda
      TrafficRoutingConfig:
        Type: TimeBasedLinear
        TimeBasedLinear:
          LinearInterval: 1
          LinearPercentage: 20

  InitiateDataRequestFunction:
    #checkov:skip=CKV_AWS_115:Defined in Globals section
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: dist/initiateDataRequest/
      Handler: handler.handler
      Environment:
        Variables:
          AUDIT_DATA_REQUEST_EVENTS_QUEUE_URL: '{{resolve:ssm:AuditDataRequestEventsQueueUrl}}'
          INITIATE_DATA_REQUEST_QUEUE_URL: !Ref InitiateDataRequestQueue
          VALID_EMAIL_RECIPIENTS_BUCKET: '{{resolve:ssm:ValidEmailRecipientsBucketName}}'
          ZENDESK_API_SECRETS_ARN: !ImportValue ZendeskSecretSetArn
          ZENDESK_FIELD_ID_DATA_PATHS: !ImportValue ZendeskFieldIdDataPaths
          ZENDESK_FIELD_ID_DATE_FROM: !ImportValue ZendeskFieldIdDateFrom
          ZENDESK_FIELD_ID_DATE_TO: !ImportValue ZendeskFieldIdDateTo
          ZENDESK_FIELD_ID_DATES: !ImportValue ZendeskFieldIdDates
          ZENDESK_FIELD_ID_EVENT_IDS: !ImportValue ZendeskFieldIdEventIds
          ZENDESK_FIELD_ID_IDENTIFIER_TYPE: !ImportValue ZendeskFieldIdIdentifierType
          ZENDESK_FIELD_ID_JOURNEY_IDS: !ImportValue ZendeskFieldIdJourneyIds
          ZENDESK_FIELD_ID_PII_TYPES: !ImportValue ZendeskFieldIdPiiTypes
          ZENDESK_FIELD_ID_RECIPIENT_EMAIL: !ImportValue ZendeskFieldIdRecipientEmail
          ZENDESK_FIELD_ID_RECIPIENT_NAME: !ImportValue ZendeskFieldIdRecipientName
          ZENDESK_FIELD_ID_SESSION_IDS: !ImportValue ZendeskFieldIdSessionIds
          ZENDESK_FIELD_ID_USER_IDS: !ImportValue ZendeskFieldIdUserIds
      Events:
        Api:
          Type: Api
          Properties:
            Path: /zendesk-webhook
            Method: POST
            RestApiId: !Ref ZendeskWebhookApi
      FunctionName: !Sub ${AWS::StackName}-initiate-data-request
      MemorySize: 512
      KmsKeyArn: '{{resolve:ssm:LambdaKmsKeyArn}}'
      Role: !GetAtt InitiateDataRequestFunctionRole.Arn
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdA
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdB
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdC
      DeploymentPreference:
        Type: !If
          - UseCanaryDeploy
          - !Ref TICFIntegrationDeploymentStrategy
          - AllAtOnce
        Role: !GetAtt LambdaDeployRole.Arn
        Alarms: !If
          - UseCanaryDeploy
          - - !Ref InitiateDataRequestLambdaAlarm
          - - !Ref 'AWS::NoValue'

  InitiateDataRequestFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-initiate-data-request-role'
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowLambdaToAssumeRole
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref ZendeskSecretsPolicy
        - !Ref InitiateDataRequestFunctionPolicy

  InitiateDataRequestFunctionPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub ${AWS::StackName}-initiate-data-request-policy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowSqsSend
            Effect: Allow
            Action:
              - sqs:SendMessage
            Resource:
              - !GetAtt InitiateDataRequestQueue.Arn
              - '{{resolve:ssm:AuditDataRequestEventsQueueArn}}'
          - Sid: UseSqsKmsKey
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource:
              - '{{resolve:ssm:SqsKmsKeyArn}}'
              - '{{resolve:ssm:AuditDataRequestEventsQueueKmsKeyArn}}'
          - Sid: S3ReadEmailRecipients
            Effect: Allow
            Action:
              - s3:GetObject
            Resource:
              - '{{resolve:ssm:ValidEmailRecipientsBucketArn}}/*'

  InitiateDataRequestLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: '{{resolve:ssm:LogsKmsKeyArn}}'
      LogGroupName: !Sub '/aws/lambda/${AWS::StackName}-initiate-data-request'
      RetentionInDays: 30

  InitiateDataRequestCslsSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Condition: CslsEgress
    Properties:
      LogGroupName: !Ref InitiateDataRequestLogs
      FilterPattern: !Ref LogSubscriptionFilterPattern
      DestinationArn: '{{resolve:ssm:CSLSLogsDestination}}'

  ProcessDataRequestFunction:
    #checkov:skip=CKV_AWS_115:Defined in Globals section
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: dist/processDataRequest/
      Handler: handler.handler
      Environment:
        Variables:
          AWS_ACCOUNT_ID: !Ref AWS::AccountId
          AUDIT_BUCKET_NAME: '{{resolve:ssm:MessageBatchBucketTXMA2Name}}'
          PERMANENT_AUDIT_BUCKET_NAME: !Sub audit-${Environment}-permanent-message-batch
          ANALYSIS_BUCKET_ARN: !GetAtt AnalysisBucket.Arn
          ANALYSIS_BUCKET_NAME: !Ref AnalysisBucket
          BATCH_JOB_MANIFEST_BUCKET_ARN: '{{resolve:ssm:BatchJobManifestBucketArn}}'
          BATCH_JOB_MANIFEST_BUCKET_NAME: '{{resolve:ssm:BatchJobManifestBucketName}}'
          BATCH_JOB_ROLE_ARN: !GetAtt BatchJobsRole.Arn
          INITIATE_ATHENA_QUERY_QUEUE_URL: !Ref InitiateAthenaQueryQueue
          INITIATE_DATA_REQUEST_QUEUE_URL: !Ref InitiateDataRequestQueue
          QUERY_REQUEST_DYNAMODB_TABLE_NAME: '{{resolve:ssm:QueryRequestTableName}}'
          TERMINATED_JOB_QUEUE_URL: !Ref TerminatedJobQueue
          ZENDESK_API_SECRETS_ARN: !ImportValue ZendeskSecretSetArn
          DATABASE_TTL_HOURS: '{{resolve:ssm:DatabaseTtlHours}}'
          DECRYPTION_LAMBDA_ARN: !GetAtt DecryptAndCopyFunction.Arn
          FEATURE_DECRYPT_DATA: '{{resolve:ssm:FeatureDecryptData}}'
      Events:
        InitiateDataRequestEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt InitiateDataRequestQueue.Arn
            BatchSize: 1
      FunctionName: !Sub ${AWS::StackName}-process-data
      MemorySize: 1024
      KmsKeyArn: '{{resolve:ssm:LambdaKmsKeyArn}}'
      Role: !GetAtt ProcessDataRequestFunctionRole.Arn
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdA
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdB
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdC
      DeploymentPreference:
        Type: !If
          - UseCanaryDeploy
          - !Ref TICFIntegrationDeploymentStrategy
          - AllAtOnce
        Role: !GetAtt LambdaDeployRole.Arn
        Alarms: !If
          - UseCanaryDeploy
          - - !Ref ProcessDataRequestLambdaAlarm
          - - !Ref 'AWS::NoValue'

  ProcessDataRequestFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-process-data-request-role'
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowLambdaToAssumeRole
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref ZendeskSecretsPolicy
        - !Ref ProcessDataRequestFunctionPolicy

  ProcessDataRequestFunctionPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub ${AWS::StackName}-process-data-request-policy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: S3Read
            Effect: Allow
            Action:
              - s3:ListBucket
            Resource:
              - !GetAtt AnalysisBucket.Arn
              - '{{resolve:ssm:MessageBatchBucketTXMA2ARN}}'
              - !Sub arn:aws:s3:::audit-${Environment}-permanent-message-batch
          - Sid: ManifestBucketWrite
            Effect: Allow
            Action:
              - s3:PutObject
            Resource: '{{resolve:ssm:BatchJobManifestBucketArn}}/*'
          - Sid: AllowCreateS3BatchJobs
            Effect: Allow
            Action:
              - s3:CreateJob
              - s3:PutJobTagging
            Resource: '*'
          - Sid: AssumeBatchJobRole
            Effect: Allow
            Action:
              - iam:PassRole
            Resource: !GetAtt BatchJobsRole.Arn
          - Sid: DecryptDatabaseKmsKey
            Effect: Allow
            Action:
              - kms:Decrypt
            Resource: '{{resolve:ssm:DatabaseKmsKeyArn}}'
          - Sid: QueryRequestTableReadWrite
            Effect: Allow
            Action:
              - dynamodb:GetItem
              - dynamodb:PutItem
              - dynamodb:UpdateItem
            Resource: '{{resolve:ssm:QueryRequestTableArn}}'
          - Sid: AllowSqsSend
            Effect: Allow
            Action:
              - sqs:SendMessage
            Resource:
              - !GetAtt InitiateAthenaQueryQueue.Arn
              - !GetAtt InitiateDataRequestQueue.Arn
              - !GetAtt TerminatedJobQueue.Arn
          - Sid: AllowSqsListenToInitiateQueue
            Effect: Allow
            Action:
              - sqs:ReceiveMessage
              - sqs:DeleteMessage
              - sqs:GetQueueAttributes
            Resource: !GetAtt InitiateDataRequestQueue.Arn
          - Sid: UseSqsKmsKey
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource: '{{resolve:ssm:SqsKmsKeyArn}}'

  ProcessDataRequestLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: '{{resolve:ssm:LogsKmsKeyArn}}'
      LogGroupName: !Sub '/aws/lambda/${AWS::StackName}-process-data'
      RetentionInDays: 30

  ProcessDataRequestCslsSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Condition: CslsEgress
    Properties:
      LogGroupName: !Ref ProcessDataRequestLogs
      FilterPattern: !Ref LogSubscriptionFilterPattern
      DestinationArn: '{{resolve:ssm:CSLSLogsDestination}}'

  DataReadyForQueryFunction:
    #checkov:skip=CKV_AWS_115:Defined in Globals section
    Type: AWS::Serverless::Function
    Properties:
      MemorySize: 512
      CodeUri: dist/dataReadyForQuery/
      Handler: handler.handler
      Environment:
        Variables:
          AWS_ACCOUNT_ID: !Ref AWS::AccountId
          AUDIT_BUCKET_NAME: '{{resolve:ssm:MessageBatchBucketTXMA2Name}}'
          PERMANENT_AUDIT_BUCKET_NAME: !Sub audit-${Environment}-permanent-message-batch
          ANALYSIS_BUCKET_ARN: !GetAtt AnalysisBucket.Arn
          ANALYSIS_BUCKET_NAME: !Ref AnalysisBucket
          INITIATE_ATHENA_QUERY_QUEUE_URL: !Ref InitiateAthenaQueryQueue
          ZENDESK_API_SECRETS_ARN: !ImportValue ZendeskSecretSetArn
      FunctionName: !Sub ${AWS::StackName}-data-ready-for-query
      KmsKeyArn: '{{resolve:ssm:LambdaKmsKeyArn}}'
      Role: !GetAtt DataReadyForQueryFunctionRole.Arn
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdA
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdB
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdC
      DeploymentPreference:
        Type: !If
          - UseCanaryDeploy
          - !Ref TICFIntegrationDeploymentStrategy
          - AllAtOnce
        Role: !GetAtt LambdaDeployRole.Arn
        Alarms: !If
          - UseCanaryDeploy
          - - !Ref DataReadyForQueryLambdaAlarm
          - - !Ref 'AWS::NoValue'

  DataReadyForQueryFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-data-ready-for-query-role'
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowLambdaToAssumeRole
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref ZendeskSecretsPolicy
        - !Ref DataReadyForQueryFunctionPolicy

  DataReadyForQueryFunctionPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub ${AWS::StackName}-data-ready-for-query-policy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: ReadS3BatchJobDetails
            Effect: Allow
            Action:
              - s3:GetJobTagging
              - s3:DescribeJob
            Resource: '*'
          - Sid: S3Read
            Effect: Allow
            Action:
              - s3:ListBucket
            Resource:
              - !GetAtt AnalysisBucket.Arn
              - '{{resolve:ssm:MessageBatchBucketTXMA2ARN}}'
              - !Sub arn:aws:s3:::audit-${Environment}-permanent-message-batch
          - Sid: QueryRequestTableReadWrite
            Effect: Allow
            Action:
              - dynamodb:GetItem
              - dynamodb:PutItem
              - dynamodb:UpdateItem
            Resource: '{{resolve:ssm:QueryRequestTableArn}}'
          - Sid: AllowSqsSend
            Effect: Allow
            Action:
              - sqs:SendMessage
            Resource:
              - !GetAtt InitiateAthenaQueryQueue.Arn
          - Sid: UseSqsKmsKey
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource: '{{resolve:ssm:SqsKmsKeyArn}}'

  DataReadyForQueryLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: '{{resolve:ssm:LogsKmsKeyArn}}'
      LogGroupName: !Sub '/aws/lambda/${AWS::StackName}-data-ready-for-query'
      RetentionInDays: 30

  DataReadyForQueryCslsSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Condition: CslsEgress
    Properties:
      LogGroupName: !Ref DataReadyForQueryLogs
      FilterPattern: !Ref LogSubscriptionFilterPattern
      DestinationArn: '{{resolve:ssm:CSLSLogsDestination}}'

  DecryptAndCopyFunction:
    #checkov:skip=CKV_AWS_115:Defined in Globals section
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: dist/decryptAndCopy/
      Handler: handler.handler
      MemorySize: 1536
      # should be less than 10% of global account concurrency so audit firehose has enough concurrency to run during peak loads
      # global account quota 3000 --> 150 which is 5%
      ReservedConcurrentExecutions: 150
      Environment:
        Variables:
          ANALYSIS_BUCKET_NAME: !Ref AnalysisBucket
          GENERATOR_KEY_ID: '{{resolve:ssm:S3EncryptionGeneratorKmsKeyArn}}'
      FunctionName: !Sub ${AWS::StackName}-decrypt-and-copy
      KmsKeyArn: '{{resolve:ssm:LambdaKmsKeyArn}}'
      Role: !GetAtt DecryptAndCopyFunctionRole.Arn
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue: !Sub ${VpcStackName}-PrivateSubnetIdA
          - Fn::ImportValue: !Sub ${VpcStackName}-PrivateSubnetIdB
          - Fn::ImportValue: !Sub ${VpcStackName}-PrivateSubnetIdC
      DeploymentPreference:
        Type: !If
          - UseCanaryDeploy
          - !Ref TICFIntegrationDeploymentStrategy
          - AllAtOnce
        Role: !GetAtt LambdaDeployRole.Arn
        Alarms: !If
          - UseCanaryDeploy
          - - !Ref DecryptAndCopyLambdaAlarm
          - - !Ref 'AWS::NoValue'

  DecryptAndCopyFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-decrypt-and-copy-role'
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowLambdaToAssumeRole
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref DecryptAndCopyFunctionPolicy

  DecryptAndCopyFunctionPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub ${AWS::StackName}-decrypt-and-copy-policy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: ReadFromPermanentBucket
            Effect: Allow
            Action:
              - s3:ListBucket
              - s3:GetObject
            Resource:
              - !Sub arn:aws:s3:::audit-${Environment}-permanent-message-batch
              - !Sub arn:aws:s3:::audit-${Environment}-permanent-message-batch/*
          - Sid: WriteToAnalysisBucket
            Effect: Allow
            Action:
              - s3:GetBucketLocation
              - s3:GetObject
              - s3:ListBucket
              - s3:ListBucketMultipartUploads
              - s3:ListMultipartUploadParts
              - s3:AbortMultipartUpload
              - s3:PutObject
            Resource:
              - !GetAtt AnalysisBucket.Arn
              - !Sub ${AnalysisBucket.Arn}/*
          - Sid: UseGeneratorKmsKey
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource: '{{resolve:ssm:S3EncryptionGeneratorKmsKeyArn}}'

  DecryptAndCopyLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: '{{resolve:ssm:LogsKmsKeyArn}}'
      LogGroupName: !Sub '/aws/lambda/${AWS::StackName}-decrypt-and-copy'
      RetentionInDays: 30

  InitiateAthenaQueryFunction:
    #checkov:skip=CKV_AWS_115:Defined in Globals section
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: dist/initiateAthenaQuery/
      Handler: handler.handler
      MemorySize: 512
      Environment:
        Variables:
          ATHENA_DATABASE_NAME: '{{resolve:ssm:AuditDataAnalysisGlueDatabaseName}}'
          ATHENA_TABLE_NAME: !Ref AuditAnalysisTable
          ATHENA_WORKGROUP_NAME: '{{resolve:ssm:TicfAutomatedDataQueriesWorkgroupName}}'
          QUERY_REQUEST_DYNAMODB_TABLE_NAME: '{{resolve:ssm:QueryRequestTableName}}'
          ZENDESK_API_SECRETS_ARN: !ImportValue ZendeskSecretSetArn
      Events:
        InitiateAthenaQueryEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt InitiateAthenaQueryQueue.Arn
            BatchSize: 1
      FunctionName: !Sub ${AWS::StackName}-initiate-athena-query
      KmsKeyArn: '{{resolve:ssm:LambdaKmsKeyArn}}'
      Role: !GetAtt InitiateAthenaQueryFunctionRole.Arn
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdA
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdB
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdC
      DeploymentPreference:
        Type: !If
          - UseCanaryDeploy
          - !Ref TICFIntegrationDeploymentStrategy
          - AllAtOnce
        Role: !GetAtt LambdaDeployRole.Arn
        Alarms: !If
          - UseCanaryDeploy
          - - !Ref InitiateAthenaQueryLambdaAlarm
          - - !Ref 'AWS::NoValue'

  InitiateAthenaQueryFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-initiate-athena-query-role'
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowLambdaToAssumeRole
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref InitiateAthenaQueryFunctionPolicy

  InitiateAthenaQueryFunctionPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub ${AWS::StackName}-initiate-athena-query-policy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: GetGlueTables
            Effect: Allow
            Action:
              - glue:GetTable
            Resource:
              - !Sub arn:${AWS::Partition}:glue:${AWS::Region}:${AWS::AccountId}:catalog
              - '{{resolve:ssm:AuditDataAnalysisGlueDatabaseArn}}'
              - !Sub arn:${AWS::Partition}:glue:${AWS::Region}:${AWS::AccountId}:table/{{resolve:ssm:AuditDataAnalysisGlueDatabaseName}}/${AuditAnalysisTable}
          - Sid: AllowQueueAccess
            Effect: Allow
            Action:
              - sqs:ReceiveMessage
              - sqs:DeleteMessage
              - sqs:GetQueueAttributes
            Resource: !GetAtt InitiateAthenaQueryQueue.Arn
          - Sid: StartAthenaQuery
            Effect: Allow
            Action:
              - athena:StartQueryExecution
            Resource: '{{resolve:ssm:TicfAutomatedDataQueriesWorkgroupArn}}'
          - Sid: ReadFromAnalysisBucket
            Effect: Allow
            Action:
              - s3:ListBucket
              - s3:GetObject
            Resource:
              - !GetAtt AnalysisBucket.Arn
              - !Sub ${AnalysisBucket.Arn}/*
          - Sid: WriteToResultsBucket
            Effect: Allow
            Action:
              - s3:GetBucketLocation
              - s3:GetObject
              - s3:ListBucket
              - s3:ListBucketMultipartUploads
              - s3:ListMultipartUploadParts
              - s3:AbortMultipartUpload
              - s3:PutObject
            Resource:
              - '{{resolve:ssm:AthenaQueryOutputBucketArn}}'
              - '{{resolve:ssm:AthenaQueryOutputBucketArn}}/*'
          - Sid: ReadSecrets
            Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !ImportValue ZendeskSecretSetArn
          - Sid: DecryptKmsKeys
            Effect: Allow
            Action:
              - kms:Decrypt
            Resource:
              - '{{resolve:ssm:DatabaseKmsKeyArn}}'
              - '{{resolve:ssm:SecretsKmsKeyArn}}'
              - '{{resolve:ssm:SqsKmsKeyArn}}'
          - Sid: QueryRequestTableReadWrite
            Effect: Allow
            Action:
              - dynamodb:PutItem
              - dynamodb:GetItem
              - dynamodb:UpdateItem
            Resource: '{{resolve:ssm:QueryRequestTableArn}}'
          - Sid: AthenaOutputEncryptKmsKey
            Effect: Allow
            Action:
              - kms:GenerateDataKey
              - kms:Encrypt
              - kms:Decrypt
            Resource: '{{resolve:ssm:AthenaQueryOutputBucketKmsKeyArn}}'

  InitiateAthenaQueryLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: '{{resolve:ssm:LogsKmsKeyArn}}'
      LogGroupName: !Sub '/aws/lambda/${AWS::StackName}-initiate-athena-query'
      RetentionInDays: 30

  InitiateAthenaQueryCslsSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Condition: CslsEgress
    Properties:
      LogGroupName: !Ref InitiateAthenaQueryLogs
      FilterPattern: !Ref LogSubscriptionFilterPattern
      DestinationArn: '{{resolve:ssm:CSLSLogsDestination}}'

  SendQueryResultsNotificationFunction:
    #checkov:skip=CKV_AWS_115:Defined in Globals section
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: dist/sendQueryResultsNotification/
      Handler: handler.handler
      Environment:
        Variables:
          QUERY_REQUEST_DYNAMODB_TABLE_NAME: '{{resolve:ssm:QueryRequestTableName}}'
          QUERY_RESULTS_BUCKET_NAME: !Sub txma-qr-infra-${Environment}-query-results-bucket
          QUERY_COMPLETED_QUEUE_URL: '{{resolve:ssm:QueryCompletedQueueUrl}}'
          ZENDESK_API_SECRETS_ARN: !ImportValue ZendeskSecretSetArn
          AUDIT_DATA_REQUEST_EVENTS_QUEUE_URL: '{{resolve:ssm:AuditDataRequestEventsQueueUrl}}'
      FunctionName: !Sub ${AWS::StackName}-send-query-results-notification
      MemorySize: 256
      KmsKeyArn: '{{resolve:ssm:LambdaKmsKeyArn}}'
      Role: !GetAtt SendQueryResultsNotificationFunctionRole.Arn
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdA
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdB
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdC
      DeploymentPreference:
        Type: !If
          - UseCanaryDeploy
          - !Ref TICFIntegrationDeploymentStrategy
          - AllAtOnce
        Role: !GetAtt LambdaDeployRole.Arn
        Alarms: !If
          - UseCanaryDeploy
          - - !Ref SendQueryResultsNotificationLambdaAlarm
          - - !Ref 'AWS::NoValue'

  SendQueryResultsNotificationFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-send-query-results-role'
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowLambdaToAssumeRole
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref SendQueryResultsNotificationFunctionPolicy

  SendQueryResultsNotificationFunctionPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub ${AWS::StackName}-send-query-results-policy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: WriteToResultsBucket
            Effect: Allow
            Action:
              - s3:AbortMultipartUpload
              - s3:GetBucketLocation
              - s3:GetObject
              - s3:ListBucket
              - s3:ListBucketMultipartUploads
              - s3:ListMultipartUploadParts
              - s3:PutObject
            Resource:
              - !Sub arn:aws:s3:::txma-qr-infra-${Environment}-query-results-bucket
              - !Sub arn:aws:s3:::txma-qr-infra-${Environment}-query-results-bucket/*
          - Sid: DecryptKmsKeys
            Effect: Allow
            Action:
              - kms:Decrypt
            Resource:
              - '{{resolve:ssm:DatabaseKmsKeyArn}}'
              - '{{resolve:ssm:SecretsKmsKeyArn}}'
              - '{{resolve:ssm:SqsKmsKeyArn}}'
          - Sid: Logs
            Effect: Allow
            Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Resource: !GetAtt SendQueryResultsNotificationLogs.Arn
          - Sid: SecretsManager
            Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !ImportValue ZendeskSecretSetArn
          - Sid: QueryRequestTableReadWrite
            Effect: Allow
            Action:
              - dynamodb:PutItem
              - dynamodb:GetItem
              - dynamodb:UpdateItem
              - dynamodb:Query
            Resource:
              - '{{resolve:ssm:QueryRequestTableArn}}'
              - '{{resolve:ssm:QueryRequestTableArn}}/index/athenaQueryIdIndex'
          - Sid: AllowSqsSend
            Effect: Allow
            Action:
              - sqs:SendMessage
            Resource:
              - '{{resolve:ssm:QueryCompletedQueueArn}}'
              - '{{resolve:ssm:AuditDataRequestEventsQueueArn}}'
          - Sid: UseSqsKmsKey
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource:
              - '{{resolve:ssm:QueryCompletedQueueKmsKeyArn}}'
              - '{{resolve:ssm:AuditDataRequestEventsQueueKmsKeyArn}}'

  SendQueryResultsNotificationLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: '{{resolve:ssm:LogsKmsKeyArn}}'
      LogGroupName: !Sub '/aws/lambda/${AWS::StackName}-send-query-results-notification'
      RetentionInDays: 30

  SendQueryResultsNotificationCslsSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Condition: CslsEgress
    Properties:
      LogGroupName: !Ref SendQueryResultsNotificationLogs
      FilterPattern: !Ref LogSubscriptionFilterPattern
      DestinationArn: '{{resolve:ssm:CSLSLogsDestination}}'

  CloseZendeskTicketFunction:
    #checkov:skip=CKV_AWS_115:Defined in Globals section
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: dist/closeZendeskTicket
      Handler: handler.handler
      Role: !GetAtt CloseZendeskTicketFunctionRole.Arn
      Environment:
        Variables:
          ZENDESK_API_SECRETS_ARN: !ImportValue ZendeskSecretSetArn
      FunctionName: !Sub ${AWS::StackName}-close-zendesk-ticket
      MemorySize: 512
      KmsKeyArn: '{{resolve:ssm:LambdaKmsKeyArn}}'
      Events:
        CloseZendeskTicketEvent:
          Type: SQS
          Properties:
            Queue: !Sub 'arn:aws:sqs:${AWS::Region}:{{resolve:ssm:QueryResultsAccountNumber}}:txma-qr-infra-${Environment}-close-zendesk-ticket-queue'
            BatchSize: 1
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdA
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdB
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdC
      DeploymentPreference:
        Type: !If
          - UseCanaryDeploy
          - !Ref TICFIntegrationDeploymentStrategy
          - AllAtOnce
        Role: !GetAtt LambdaDeployRole.Arn
        Alarms: !If
          - UseCanaryDeploy
          - - !Ref CloseZendeskTicketLambdaAlarm
          - - !Ref 'AWS::NoValue'

  CloseZendeskTicketFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${AWS::StackName}-${Environment}-close-zendesk-ticket-role
      PermissionsBoundary:
        !If [
          UsePermissionsBoundary,
          !Ref PermissionsBoundary,
          !Ref AWS::NoValue
        ]
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref CloseZendeskTicketFunctionPolicy

  CloseZendeskTicketFunctionPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub ${AWS::StackName}-close-zendesk-ticket-policy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: ReadSecrets
            Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource:
              - !ImportValue ZendeskSecretSetArn
          - Sid: AllowCloseZendeskTicketQueueRead
            Effect: Allow
            Action:
              - sqs:ReceiveMessage
              - sqs:DeleteMessage
              - sqs:GetQueueAttributes
            Resource: !Sub 'arn:aws:sqs:${AWS::Region}:{{resolve:ssm:QueryResultsAccountNumber}}:txma-qr-infra-${Environment}-close-zendesk-ticket-queue'
          - Sid: DecryptKmsKeys
            Effect: Allow
            Action:
              - kms:Decrypt
            Resource:
              - '{{resolve:ssm:SecretsKmsKeyArn}}'
              - !Sub 'arn:aws:kms:${AWS::Region}:{{resolve:ssm:QueryResultsAccountNumber}}:*'

  CloseZendeskTicketLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: '{{resolve:ssm:LogsKmsKeyArn}}'
      LogGroupName: !Sub '/aws/lambda/${AWS::StackName}-close-zendesk-ticket'
      RetentionInDays: 30

  CloseZendeskTicketCslsSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Condition: CslsEgress
    Properties:
      LogGroupName: !Ref CloseZendeskTicketLogs
      FilterPattern: !Ref LogSubscriptionFilterPattern
      DestinationArn: '{{resolve:ssm:CSLSLogsDestination}}'

  PermissionForAthenaEventToInvokeLambda:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SendQueryResultsNotificationFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt AthenaEBRule.Arn

  ###################################
  # Monitoring and Alerting Resources
  ###################################

  InitiateDataRequestLambdaFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterPattern: '{ $.level = "ERROR" }'
      LogGroupName: !Ref InitiateDataRequestLogs
      MetricTransformations:
        - MetricValue: '1'
          MetricNamespace: TxMA/TICFIntegration/Logs
          MetricName: 'InitiateDataRequestLambdaMetric'

  ProcessDataRequestLambdaFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterPattern: '{ $.level = "ERROR" }'
      LogGroupName: !Ref ProcessDataRequestLogs
      MetricTransformations:
        - MetricValue: '1'
          MetricNamespace: TxMA/TICFIntegration/Logs
          MetricName: 'ProcessDataRequestLambdaMetric'

  DataReadyForQueryLambdaFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterPattern: '{ $.level = "ERROR" }'
      LogGroupName: !Ref DataReadyForQueryLogs
      MetricTransformations:
        - MetricValue: '1'
          MetricNamespace: TxMA/TICFIntegration/Logs
          MetricName: 'DataReadyForQueryLambdaMetric'

  DecryptAndCopyLambdaFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterPattern: '{ $.level = "ERROR" }'
      LogGroupName: !Ref DecryptAndCopyLogs
      MetricTransformations:
        - MetricValue: '1'
          MetricNamespace: TxMA/TICFIntegration/Logs
          MetricName: 'DecryptAndCopyLambdaMetric'

  InitiateAthenaQueryLambdaFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterPattern: '{ $.level = "ERROR" }'
      LogGroupName: !Ref InitiateAthenaQueryLogs
      MetricTransformations:
        - MetricValue: '1'
          MetricNamespace: TxMA/TICFIntegration/Logs
          MetricName: 'InitiateAthenaQueryLambdaMetric'

  SendQueryResultsNotificationLambdaFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterPattern: '{ $.level = "ERROR" }'
      LogGroupName: !Ref SendQueryResultsNotificationLogs
      MetricTransformations:
        - MetricValue: '1'
          MetricNamespace: TxMA/TICFIntegration/Logs
          MetricName: 'SendQueryResultsNotificationLambdaMetric'

  CloseZendeskTicketLambdaFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterPattern: '{ $.level = "ERROR" }'
      LogGroupName: !Ref CloseZendeskTicketLogs
      MetricTransformations:
        - MetricValue: '1'
          MetricNamespace: TxMA/TICFIntegration/Logs
          MetricName: 'CloseZendeskTicketLambdaMetric'

  InitiateDataRequestLambdaAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions:
        - !ImportValue txma-alarms-slack-alerts-BuildNotificationTopicArn
      AlarmDescription: 'An alarm that is triggered by any error within the InitiateDataRequestFunction lambda.'
      AlarmName: !Sub ${AWS::StackName}-initiate-data-request-lambda-alarm
      ComparisonOperator: GreaterThanOrEqualToThreshold
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      MetricName: InitiateDataRequestLambdaMetric
      Namespace: TxMA/TICFIntegration/Logs
      Period: 3600
      Statistic: Sum
      Threshold: 1
      TreatMissingData: notBreaching

  ProcessDataRequestLambdaAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions:
        - !ImportValue txma-alarms-slack-alerts-BuildNotificationTopicArn
      AlarmDescription: 'An alarm that is triggered by any error within the ProcessDataRequestFunction lambda.'
      AlarmName: !Sub ${AWS::StackName}-process-data-request-lambda-alarm
      ComparisonOperator: GreaterThanOrEqualToThreshold
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      MetricName: ProcessDataRequestLambdaMetric
      Namespace: TxMA/TICFIntegration/Logs
      Period: 3600
      Statistic: Sum
      Threshold: 1
      TreatMissingData: notBreaching

  DataReadyForQueryLambdaAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions:
        - !ImportValue txma-alarms-slack-alerts-BuildNotificationTopicArn
      AlarmDescription: 'An alarm that is triggered by any error within the DataReadyForQueryFunction lambda.'
      AlarmName: !Sub ${AWS::StackName}-data-ready-for-query-lambda-alarm
      ComparisonOperator: GreaterThanOrEqualToThreshold
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      MetricName: DataReadyForQueryLambdaMetric
      Namespace: TxMA/TICFIntegration/Logs
      Period: 3600
      Statistic: Sum
      Threshold: 1
      TreatMissingData: notBreaching

  DecryptAndCopyLambdaAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions:
        - !ImportValue txma-alarms-slack-alerts-BuildNotificationTopicArn
      AlarmDescription: 'An alarm that is triggered by any error within the DecryptAndCopyFunction lambda.'
      AlarmName: !Sub ${AWS::StackName}-decrypt-and-copy-lambda-alarm
      ComparisonOperator: GreaterThanOrEqualToThreshold
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      MetricName: DecryptAndCopyLambdaMetric
      Namespace: TxMA/TICFIntegration/Logs
      Period: 3600
      Statistic: Sum
      Threshold: 1
      TreatMissingData: notBreaching

  InitiateAthenaQueryLambdaAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions:
        - !ImportValue txma-alarms-slack-alerts-BuildNotificationTopicArn
      AlarmDescription: 'An alarm that is triggered by any error within the InitiateAthenaQueryFunction lambda.'
      AlarmName: !Sub ${AWS::StackName}-initiate-athena-query-lambda-alarm
      ComparisonOperator: GreaterThanOrEqualToThreshold
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      MetricName: InitiateAthenaQueryLambdaMetric
      Namespace: TxMA/TICFIntegration/Logs
      Period: 3600
      Statistic: Sum
      Threshold: 1
      TreatMissingData: notBreaching

  SendQueryResultsNotificationLambdaAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions:
        - !ImportValue txma-alarms-slack-alerts-BuildNotificationTopicArn
      AlarmDescription: 'An alarm that is triggered by any error within the SendQueryResultsNotificationFunction lambda.'
      AlarmName: !Sub ${AWS::StackName}-send-query-results-notification-lambda-alarm
      ComparisonOperator: GreaterThanOrEqualToThreshold
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      MetricName: SendQueryResultsNotificationLambdaMetric
      Namespace: TxMA/TICFIntegration/Logs
      Period: 3600
      Statistic: Sum
      Threshold: 1
      TreatMissingData: notBreaching

  CloseZendeskTicketLambdaAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions:
        - !ImportValue txma-alarms-slack-alerts-BuildNotificationTopicArn
      AlarmDescription: 'An alarm that is triggered by any error within the CloseZendeskTicketFunction lambda.'
      AlarmName: !Sub ${AWS::StackName}-close-zendesk-ticket-lambda-alarm
      ComparisonOperator: GreaterThanOrEqualToThreshold
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      MetricName: CloseZendeskTicketLambdaMetric
      Namespace: TxMA/TICFIntegration/Logs
      Period: 3600
      Statistic: Sum
      Threshold: 1
      TreatMissingData: notBreaching

  ##################
  # Athena Resources
  ##################

  AuditAnalysisTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: '{{resolve:ssm:AuditDataAnalysisGlueDatabaseName}}'
      TableInput:
        Description: Table contains event message data to be analysed
        Name:
          !Join [
            '',
            [
              !Join ['', !Split ['-', !Ref AWS::StackName]],
              !Sub '_${Environment}_analysis_table'
            ]
          ]
        Parameters:
          has_encrypted_data: false
          projection.enabled: true
          projection.datetime.type: date
          projection.datetime.range: '2022/01/01,NOW'
          projection.datetime.format: 'yyyy/MM/dd'
          projection.datetime.interval: 1
          projection.datetime.interval.unit: DAYS
          storage.location.template:
            !Join ['', ['s3://', !Ref AnalysisBucket, '/firehose/${datetime}/']]
        PartitionKeys:
          - Name: datetime
            Type: string
        StorageDescriptor:
          Columns:
            - Name: event_id
              Type: string
            - Name: user_id
              Type: string
            - Name: client_id
              Type: string
            - Name: timestamp
              Type: bigint
            - Name: timestamp_formatted
              Type: string
            - Name: event_timestamp_ms
              Type: bigint
            - Name: event_timestamp_ms_formatted
              Type: string
            - Name: event_name
              Type: string
            - Name: component_id
              Type: string
            - Name: user
              Type: string
            - Name: platform
              Type: string
            - Name: restricted
              Type: string
            - Name: extensions
              Type: string
          Compressed: true
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Sub s3://${AnalysisBucket}/firehose/
          OutputFormat: org.apache.hadoop.hive.ql.io.IgnoreKeyTextOutputFormat
          SerdeInfo:
            Parameters:
              {
                'ignore.malformed.json': true,
                'serialiazation.format': 1,
                'field.delim': '',
                'case.insensitive': false
              }
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE

  AthenaEBRule:
    Type: AWS::Events::Rule
    Properties:
      Description: The rule listening for Athena Status Change Events and triggering the sendQueryResultsNotification lambda
      EventPattern:
        source:
          - 'aws.athena'
        detail-type:
          - 'Athena Query State Change'
        detail:
          currentState:
            - 'SUCCEEDED'
            - 'FAILED'
            - 'CANCELLED'
      State: 'ENABLED'
      Targets:
        - Arn: !GetAtt SendQueryResultsNotificationFunction.Arn
          Id: AthenaEventTarget

  ####################
  # Shared IAM policies
  #####################
  ZendeskSecretsPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub ${AWS::StackName}-zendesk-secrets-policy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: ReadSecrets
            Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !ImportValue ZendeskSecretSetArn
          - Sid: DecryptSecrets
            Effect: Allow
            Action:
              - kms:Decrypt
            Resource: '{{resolve:ssm:SecretsKmsKeyArn}}'

  ##############
  # S3 Resources
  ##############

  AnalysisBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      BucketName: !Sub ${AWS::StackName}-${Environment}-analysis-bucket
      LifecycleConfiguration:
        Rules:
          - Id: AnalysisCleanupRule
            Status: Enabled
            ExpirationInDays: 7
            NoncurrentVersionExpiration:
              NoncurrentDays: 1
          - !If
            - TestRoleResources
            - Id: DeleteAutoTestObjects
              Status: Enabled
              ExpirationInDays: 1
              NoncurrentVersionExpiration:
                NoncurrentDays: 1
              TagFilters:
                - Key: autoTest
                  Value: 'true'
            - !Ref AWS::NoValue
      LoggingConfiguration:
        DestinationBucketName: '{{resolve:ssm:S3LogsBucketName}}'
        LogFilePrefix: !Sub ${AWS::StackName}-${Environment}-analysis-bucket/
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled

  GlacierMigrationTempBucket:
    Condition: BuildEnvironment
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      BucketName: !Sub ${AWS::StackName}-${Environment}-glac-mig-bucket
      LifecycleConfiguration:
        Rules:
          - Id: AnalysisCleanupRule
            Status: Enabled
            ExpirationInDays: 14
            NoncurrentVersionExpiration:
              NoncurrentDays: 1
          - !If
            - TestRoleResources
            - Id: DeleteAutoTestObjects
              Status: Enabled
              ExpirationInDays: 1
              NoncurrentVersionExpiration:
                NoncurrentDays: 1
              TagFilters:
                - Key: autoTest
                  Value: 'true'
            - !Ref AWS::NoValue
      LoggingConfiguration:
        DestinationBucketName: '{{resolve:ssm:S3LogsBucketName}}'
        LogFilePrefix: !Sub ${AWS::StackName}-${Environment}-glac-mig-bucket/
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled

  BatchJobsRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${AWS::StackName}-${Environment}-batch-jobs-role
      PermissionsBoundary:
        !If [
          UsePermissionsBoundary,
          !Ref PermissionsBoundary,
          !Ref AWS::NoValue
        ]
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - batchoperations.s3.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Ref DataTransferBatchJobPermissionsPolicy

  DataTransferBatchJobPermissionsPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub ${AWS::StackName}-data-transfer-job-policy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowAuditBucketRestore
            Effect: Allow
            Action:
              - s3:RestoreObject
            Resource:
              - '{{resolve:ssm:MessageBatchBucketTXMA2ARN}}/*'
              - !Sub 'arn:aws:s3:::audit-${Environment}-permanent-message-batch/*'
          - Sid: AllowManifestBucketRead
            Effect: Allow
            Action:
              - s3:GetObject
              - s3:GetObjectVersion
            Resource: '{{resolve:ssm:BatchJobManifestBucketArn}}/*'
          - Sid: AllowManifestBucketWriteForReports
            Effect: Allow
            Action:
              - s3:PutObject
            Resource: '{{resolve:ssm:BatchJobManifestBucketArn}}/*'
          - Sid: AllowAnalysisBucketWrite
            Effect: Allow
            Action:
              - s3:PutObject
              - s3:PutObjectAcl
              - s3:PutObjectTagging
            Resource: !Sub ${AnalysisBucket.Arn}/*
          - Sid: AllowAuditBucketRead
            Effect: Allow
            Action:
              - s3:GetObject
              - s3:GetObjectAcl
              - s3:GetObjectTagging
              - s3:ListBucket
            Resource:
              - '{{resolve:ssm:MessageBatchBucketTXMA2ARN}}/*'
          - Sid: AllowDecryptLambdaExecute
            Effect: Allow
            Action:
              - lambda:InvokeFunction
            Resource: !GetAtt DecryptAndCopyFunction.Arn

  EmptyS3Buckets:
    Condition: DevEnvironment
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: '{{resolve:ssm:EmptyS3BucketsFunctionArn}}'

  BatchJobEventBridgeRule:
    Type: AWS::Events::Rule
    Properties:
      Description: The rule listening for S3 Batch Job Status Change Events and triggering the dataReadyForQuery lambda
      EventPattern:
        source:
          - 'aws.s3'
        detail-type:
          - 'AWS Service Event via CloudTrail'
        detail:
          eventSource:
            - 's3.amazonaws.com'
          eventName:
            - 'JobStatusChanged'
      State: 'ENABLED'
      Targets:
        - Arn: !GetAtt DataReadyForQueryFunction.Arn
          Id: BatchJobEventTarget

  PermissionForBatchJobStatusEventToInvokeLambda:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref DataReadyForQueryFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt BatchJobEventBridgeRule.Arn

  ###############
  # SQS Resources
  ###############

  InitiateDataRequestQueue:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId: '{{resolve:ssm:SqsKmsKeyArn}}'
      QueueName: !Sub ${AWS::StackName}-initiate-data-request-queue
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt InitiateDataRequestDeadLetterQueue.Arn
        maxReceiveCount: 5

  InitiateDataRequestDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId: '{{resolve:ssm:SqsKmsKeyArn}}'
      QueueName: !Sub ${AWS::StackName}-initiate-data-request-dlq

  TerminatedJobQueue:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId: '{{resolve:ssm:SqsKmsKeyArn}}'
      QueueName: !Sub ${AWS::StackName}-terminated-job-queue

  InitiateAthenaQueryQueue:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId: '{{resolve:ssm:SqsKmsKeyArn}}'
      QueueName: !Sub ${AWS::StackName}-initiate-athena-query-queue
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt InitiateAthenaQueryDeadLetterQueue.Arn
        maxReceiveCount: 5

  InitiateAthenaQueryDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId: '{{resolve:ssm:SqsKmsKeyArn}}'
      QueueName: !Sub ${AWS::StackName}-initiate-athena-query-dlq

  #################################
  # Start: Glacier Migration resources #
  #################################

  GlacierMigrationFunction:
    #checkov:skip=CKV_AWS_115:Defined in Globals section
    Condition: BuildEnvironment
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: dist/glacierMigration/
      Handler: handler.handler
      Environment:
        Variables:
          AWS_ACCOUNT_ID: !Ref AWS::AccountId
          ORIGINAL_BUCKET: !Sub audit-${Environment}-permanent-message-batch
          RESTORED_BUCKET: !Ref GlacierMigrationTempBucket
          MANIFEST_BUCKET: '{{resolve:ssm:BatchJobManifestBucketName}}'
          BATCH_JOB_ROLE: !GetAtt BatchJobsRole.Arn
      FunctionName: !Sub ${AWS::StackName}-glacier-migration
      MemorySize: 512
      Timeout: 900
      KmsKeyArn: '{{resolve:ssm:LambdaKmsKeyArn}}'
      Role: !GetAtt GlacierMigrationFunctionRole.Arn
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdA
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdB
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdC
      DeploymentPreference:
        Type: !If
          - UseCanaryDeploy
          - !Ref TICFIntegrationDeploymentStrategy
          - AllAtOnce
        Role: !GetAtt LambdaDeployRole.Arn

  GlacierMigrationFunctionRole:
    Condition: BuildEnvironment
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-glacier-migration-role'
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowLambdaToAssumeRole
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - !Ref GlacierMigrationFunctionPolicy

  GlacierMigrationFunctionPolicy:
    Condition: BuildEnvironment
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub ${AWS::StackName}-glacier-migration-policy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: S3ReadFromRestoredBucket
            Effect: Allow
            Action:
              - s3:GetObject
              - s3:ListBucket
            Resource:
              - !GetAtt GlacierMigrationTempBucket.Arn
              - !Sub ${GlacierMigrationTempBucket.Arn}/*
          - Sid: S3WriteToManifestBucket
            Effect: Allow
            Action:
              - s3:PutObject
            Resource: '{{resolve:ssm:BatchJobManifestBucketArn}}/*'
          - Sid: CreateS3BatchJobs
            Effect: Allow
            Action:
              - s3:CreateJob
              - s3:PutJobTagging
            Resource: '*'
          - Sid: PassBatchJobRole
            Effect: Allow
            Action:
              - iam:PassRole
            Resource: !GetAtt BatchJobsRole.Arn
          - Sid: UseSqsKmsKey
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource: '{{resolve:ssm:SqsKmsKeyArn}}'

  GlacierMigrationLogs:
    Condition: BuildEnvironment
    Type: AWS::Logs::LogGroup
    Properties:
      KmsKeyId: '{{resolve:ssm:LogsKmsKeyArn}}'
      LogGroupName: !Sub '/aws/lambda/${AWS::StackName}-glacier-migration'
      RetentionInDays: 30

  ###############################
  # End: Glacier Migration resources #
  ###############################

  ############################
  # Integration Test Resources
  ############################

  DynamoOperationsLambdaPolicy:
    Condition: TestRoleResources
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt IntegrationTestsDynamoOperationsFunctionNameParameter.Value
      Principal: !Ref TestRoleArn

  S3ReadFileLambdaPolicy:
    Condition: TestRoleResources
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt IntegrationTestsReadS3FileToStringFunctionNameParameter.Value
      Principal: !Ref TestRoleArn

  S3OperationsLambdaPolicy:
    Condition: TestRoleResources
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt IntegrationTestsS3OperationsFunctionNameParameter.Value
      Principal: !Ref TestRoleArn

  CheckS3FileExistsLambdaPolicy:
    Condition: TestRoleResources
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt IntegrationTestsCheckS3FileExistsFunctionNameParameter.Value
      Principal: !Ref TestRoleArn

  InitiateAthenaQueryQueuePolicy:
    Condition: TestRoleResources
    Type: AWS::SQS::QueuePolicy
    Properties:
      PolicyDocument:
        Statement:
          - Sid: Allow test role send message
            Action:
              - sqs:SendMessage
            Effect: Allow
            Resource: !GetAtt InitiateAthenaQueryQueue.Arn
            Principal:
              AWS:
                - !Ref TestRoleArn
      Queues:
        - !Ref InitiateAthenaQueryQueue

  IntegrationTestsAuditBucketNameParameter:
    Condition: TestEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /tests/${AWS::StackName}/AuditBucketName
      Type: String
      Value: '{{resolve:ssm:MessageBatchBucketTXMA2Name}}'

  IntegrationTestsPermanentAuditBucketNameParameter:
    Condition: TestEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /tests/${AWS::StackName}/PermanentAuditBucketName
      Type: String
      Value: !Sub audit-${Environment}-permanent-message-batch

  IntegrationTestsTemporaryAuditBucketNameParameter:
    Condition: TestEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /tests/${AWS::StackName}/TemporaryAuditBucketName
      Type: String
      Value: !Sub audit-${Environment}-temporary-message-batch

  IntegrationTestsAuditRequestTableNameParameter:
    Condition: TestEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /tests/${AWS::StackName}/QueryRequestTableName
      Type: String
      Value: '{{resolve:ssm:QueryRequestTableName}}'

  IntegrationTestsFeatureDecryptDataParameter:
    Condition: TestEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /tests/${AWS::StackName}/FeatureDecryptData
      Type: String
      Value: '{{resolve:ssm:FeatureDecryptData}}'

  IntegrationTestsDynamoOperationsFunctionNameParameter:
    Condition: TestEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /tests/${AWS::StackName}/DynamoOperationsFunctionName
      Type: String
      Value: '{{resolve:ssm:/tests/DynamoOperationsFunctionName}}'

  IntegrationTestsReadS3FileToStringFunctionNameParameter:
    Condition: TestEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /tests/${AWS::StackName}/ReadS3FileToStringFunctionName
      Type: String
      Value: '{{resolve:ssm:/tests/ReadS3FileToStringFunctionName}}'

  IntegrationTestsCheckS3FileExistsFunctionNameParameter:
    Condition: TestEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /tests/${AWS::StackName}/CheckS3FileExistsFunctionName
      Type: String
      Value: '{{resolve:ssm:/tests/CheckS3FileExistsFunctionName}}'

  IntegrationTestsS3OperationsFunctionNameParameter:
    Condition: TestEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /tests/${AWS::StackName}/S3OperationsFunctionName
      Type: String
      Value: '{{resolve:ssm:/tests/S3OperationsFunctionName}}'

  IntegrationTestsSqsOperationsFunctionNameParameter:
    Condition: TestEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /tests/${AWS::StackName}/SqsOperationsFunctionName
      Type: String
      Value: '{{resolve:ssm:/tests/SqsOperationsFunctionName}}'

  IntegrationTestDataBucketNameParameter:
    Condition: TestEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /tests/${AWS::StackName}/IntegrationTestDataBucketName
      Type: String
      Value: '{{resolve:ssm:/tests/IntegrationTestDataBucketName}}'

  IntegrationTestDataBucketArnParameter:
    Condition: TestEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /tests/${AWS::StackName}/IntegrationTestDataBucketArn
      Type: String
      Value: '{{resolve:ssm:/tests/IntegrationTestDataBucketArn}}'

  IntegrationTestsAthenaOutputBucketNameParameter:
    Condition: TestEnvironment
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /tests/${AWS::StackName}/IntegrationTestsAthenaOutputBucketName
      Type: String
      Value: '{{resolve:ssm:AthenaQueryOutputBucketName}}'

  IntegrationTestsNotifySecretSet:
    Condition: TestEnvironment
    Type: AWS::SecretsManager::Secret
    # checkov:skip=CKV_AWS_149:"Ensure that Secrets Manager secret is encrypted using KMS CMK"
    Properties:
      Name: !Sub tests/${AWS::StackName}/NotifySecrets
      KmsKeyId: 'alias/aws/secretsmanager'

  IntegrationTestsZendeskecretSet:
    Condition: TestEnvironment
    Type: AWS::SecretsManager::Secret
    # checkov:skip=CKV_AWS_149:"Ensure that Secrets Manager secret is encrypted using KMS CMK"
    Properties:
      Name: !Sub tests/${AWS::StackName}/ZendeskSecrets
      KmsKeyId: 'alias/aws/secretsmanager'

  SqsOperationsLambdaPolicy:
    Condition: TestRoleResources
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt IntegrationTestsSqsOperationsFunctionNameParameter.Value
      Principal: !Ref TestRoleArn

Outputs:
  AnalysisBucketName:
    Value: !Ref AnalysisBucket
  InitiateAthenaQueryQueueUrl:
    Value: !Ref InitiateAthenaQueryQueue
  InitiateAthenaQueryLambdaLogGroupName:
    Value: !Ref InitiateAthenaQueryLogs
  InitiateDataRequestLambdaLogGroupName:
    Value: !Ref InitiateDataRequestLogs
  ProcessDataRequestLambdaLogGroupName:
    Value: !Ref ProcessDataRequestLogs
  DataReadyForQueryLogsLambdaLogGroupName:
    Value: !Ref DataReadyForQueryLogs
  ZendeskWebhookApiUrl:
    Value:
      !If [
        ApiCustomDomain,
        'https://{{resolve:ssm:ZendeskWebhookApiDomainName}}',
        !Sub 'https://${ZendeskWebhookApi}.execute-api.${AWS::Region}.amazonaws.com/${ZendeskWebhookApi.Stage}'
      ]
