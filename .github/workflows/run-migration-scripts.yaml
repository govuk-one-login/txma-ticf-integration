name: Run Migration Scripts

on:
  workflow_dispatch:
    inputs:
      script_name:
        description: 'Migration script to run'
        required: true
        type: choice
        options:
          - step1-initiate-restore.sh
          - step2-create-backup.sh
          - step3-migrate.sh
      environment:
        description: 'Environment to run against'
        required: true
        type: choice
        options:
          - build
          - staging
          - integration
          - production
        default: build
      aws_account_id:
        description: 'AWS Account ID'
        required: false
        type: choice
        options:
          - 761029721660
          - 778587367904
          - 423448613278
          - 348043515437
      source_bucket:
        description: 'Source bucket (optional override)'
        required: false
        type: string
      dest_bucket:
        description: 'Destination bucket (optional override)'
        required: false
        type: string
      prefix:
        description: 'Prefix filter for objects (optional)'
        required: false
        type: string
      state_run_number:
        description: 'Run number from step1 (required for step2/step3)'
        required: false
        type: string
      run_id:
        description: 'Run ID from step1 (required for step2/step3)'
        required: false
        type: string

env:
  AWS_REGION: eu-west-2

jobs:
  run-migration-script:
    name: Run Migration Script
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Check out repository code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Setup AWS CLI
        uses: aws-actions/setup-sam@c71dd89d980e49367c70391e8ada4353f52f2800

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@00943011d9042930efac3dcd3a170e4273319bc8
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ inputs.environment == 'build' && secrets.GH_ACTIONS_BUILD_ROLE_ARN || inputs.environment == 'staging' && secrets.GH_ACTIONS_STAGING_ROLE_ARN || inputs.environment == 'integration' && secrets.GH_ACTIONS_INTEGRATION_ROLE_ARN || inputs.environment == 'production' && secrets.GH_ACTIONS_PRODUCTION_ROLE_ARN || secrets.GH_ACTIONS_BUILD_ROLE_ARN }}

      - name: Log execution details
        run: |
          echo "=== MIGRATION SCRIPT EXECUTION AUDIT LOG ===" | tee -a migration-audit.log
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" | tee -a migration-audit.log
          echo "Script: ${{ inputs.script_name }}" | tee -a migration-audit.log
          echo "Environment: ${{ inputs.environment }}" | tee -a migration-audit.log
          echo "Triggered by: ${{ github.actor }}" | tee -a migration-audit.log
          echo "Run ID: ${{ github.run_id }}" | tee -a migration-audit.log
          echo "Run Number: ${{ github.run_number }}" | tee -a migration-audit.log
          echo "Repository: ${{ github.repository }}" | tee -a migration-audit.log
          echo "Ref: ${{ github.ref }}" | tee -a migration-audit.log
          echo "SHA: ${{ github.sha }}" | tee -a migration-audit.log
          echo "AWS Account: $(aws sts get-caller-identity --query Account --output text)" | tee -a migration-audit.log
          echo "AWS Identity: $(aws sts get-caller-identity --query Arn --output text)" | tee -a migration-audit.log
          echo "Parameters:" | tee -a migration-audit.log
          echo "  AWS Account ID: ${{ inputs.aws_account_id }}" | tee -a migration-audit.log
          echo "  Source Bucket: ${{ inputs.source_bucket }}" | tee -a migration-audit.log
          echo "  Dest Bucket: ${{ inputs.dest_bucket }}" | tee -a migration-audit.log
          echo "  Prefix: ${{ inputs.prefix }}" | tee -a migration-audit.log
          echo "  State Run Number: ${{ inputs.state_run_number }}" | tee -a migration-audit.log
          echo "=============================================" | tee -a migration-audit.log

      - name: Make script executable
        run: chmod +x glacier_to_glacierir_migration/${{ inputs.script_name }}

      - name: Download migration state
        if: inputs.script_name != 'step1-initiate-restore.sh'
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0
        with:
          name: migration-state-${{ inputs.state_run_number }}
          path: glacier_to_glacierir_migration/
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          run-id: ${{ inputs.run_id }}

      - name: Run migration script
        working-directory: glacier_to_glacierir_migration
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          AWS_ACCOUNT_ID: ${{ inputs.aws_account_id }}
          SOURCE_BUCKET: ${{ inputs.source_bucket }}
          DEST_BUCKET: ${{ inputs.dest_bucket }}
          PREFIX: ${{ inputs.prefix }}
        run: |
          echo "Starting script execution..." | tee -a ../migration-audit.log
          echo "Script output:" | tee -a ../migration-audit.log
          ./${{ inputs.script_name }} 2>&1 | tee -a ../migration-audit.log
          echo "Script completed with exit code: $?" | tee -a ../migration-audit.log

      - name: Upload migration state
        if: inputs.script_name == 'step1-initiate-restore.sh'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: migration-state-${{ github.run_number }}
          path: |
            glacier_to_glacierir_migration/*.txt
            glacier_to_glacierir_migration/*.json
          retention-days: 7

      - name: Upload audit log
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: migration-audit-log-${{ github.run_number }}
          path: migration-audit.log
          retention-days: 90

      - name: Upload generated files
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: migration-files-${{ github.run_number }}
          path: |
            glacier_to_glacierir_migration/*.json
            glacier_to_glacierir_migration/*.csv
          retention-days: 30

      - name: Log completion
        if: always()
        run: |
          echo "=== EXECUTION COMPLETED ===" | tee -a migration-audit.log
          echo "Completion time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" | tee -a migration-audit.log
          echo "Final status: ${{ job.status }}" | tee -a migration-audit.log
